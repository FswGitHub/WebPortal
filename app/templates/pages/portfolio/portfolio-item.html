<link rel="import" href="../dashboard/chart-board.html">
<polymer-element name="portfolio-item">
    <template>
        <link rel="stylesheet" href="../../../css/portfolio-item.css">
        <link rel="stylesheet" href="../../../css/calendar-dialog.css">
        <side-menu class="{{page.class}}" pageUrl="{{page.url}}" pageTitle="{{page.title}}" pageTabs="{{page.tabs}}" tabsArray="{{tabs}}" pagePanel="{{page.panel}}">
            <div subheader class="indent subheader" layout horizontal flex>
                <div class="calendar-block" layout horizontal center flex two>
                    <paper-button class="calendar-button" on-tap="{{openCalendar}}" relative layout horizontal>
                        <core-icon icon="event" class="open-calendar-icon"></core-icon>
                        <span class="selected-date">{{curDate}}</span>
                        <core-icon icon="arrow-drop-down" class="open-calendar-icon"></core-icon>
                    </paper-button>
                    <paper-dropdown opened="{{calendarStatus}}" id="calendarDialogWrapper">
                        <d-calendar class="portfolio-item-calendar" selectedDate="{{selectedDate}}" on-d-calendar-date-selected="{{dateSelected}}"></d-calendar>
                        <div class="actions">
                            <paper-button role="button" class="closeCalendar" on-tap="{{closeCalendarDialog}}">Cancel</paper-button>
                            <paper-button role="button" class="setDate" on-tap="{{saveCalendarStatus}}">OK</paper-button>
                        </div>
                    </paper-dropdown>
                </div>
                <div class="holding-view" layout horizontal center flex two>
                    <core-icon icon="description" class="open-calendar-icon"></core-icon>
                    <paper-dropdown-menu>
                        <paper-dropdown class="dropdown">
                            <core-selector class="menu" valueattr="view" selected="1">
                                <paper-item view="1" on-tap="{{toggleIcb}}">ICB</paper-item>
                                <paper-item view="2" on-tap="{{toggleStat}}">Statutory</paper-item>
                            </core-selector>
                        </paper-dropdown>
                    </paper-dropdown-menu>
                </div>
                <template is="auto-binding">
                    <core-media-query query="max-width: 640px"
                                      queryMatches="{{phoneScreen}}"></core-media-query>
                    <div class="search-block" layout horizontal center hidden?="{{phoneScreen}}" flex six>
                        <core-field class="search-field">
                            <input placeholder="Filter by name" flex>
                            <core-icon icon="search"></core-icon>
                        </core-field>
                    </div>
                </template>
            </div>
            <div tab0 class="dashboard-view tab-page-content" fit>
                <div class="dashboard-dropdown">
                    <paper-fab class="open" icon="add" on-tap="{{openMenu}}" relative></paper-fab>
                    <paper-dropdown opened="{{menuStatus}}" class="dashboard-menu-dropdown" halign="right" valign="{{menuPosition}}">
                        <div class="menu-list menu">
                            <paper-item class="item">
                                <div class="label">Holding Charts</div>
                                <paper-ripple fit></paper-ripple>
                            </paper-item>
                            <paper-item class="item">
                                <div class="label" >Corporate Events</div>
                                <paper-ripple fit></paper-ripple>
                            </paper-item>
                            <paper-item class="item">
                                <div class="label">Calendar Events</div>
                                <paper-ripple fit></paper-ripple>
                            </paper-item>
                        </div>
                    </paper-dropdown>
                </div>
                <template repeat="{{val in portfolioCharts}}">
                    <chart-board name="{{val.name}}" type="{{val.type}}" values="{{val.data}}"></chart-board>
                </template>
            </div>
            <div tab1 class="holdings-view tab-page-content" fit id="holdings">
                <template is="auto-binding">
                    <core-media-query query="max-width: 640px"
                                      queryMatches="{{phoneScreen}}"></core-media-query>
                    <div layout vertical?="{{phoneScreen}}"
                         horizontal?="{{!phoneScreen}}" start?="{{!phoneScreen}}" class="holding-table-navigation">
                        <core-selector layout horizontal start>
                            <div><button class="holding-nav-button" on-tap="{{first}}">First</button></div>
                            <div><button class="holding-nav-button" on-tap="{{prev}}">&#60;&#60;<span class="hide-nav">Prev</span></button></div>
                            <core-selector id="pages" valueattr="name" selected="1" layout horizontal start>
                                <div name="1" class="table-page-item">1</div>
                                <div name="2" class="table-page-item">2</div>
                                <div name="3" class="table-page-item">3</div>
                                <div name="4" class="table-page-item">4</div>
                            </core-selector>
                            <div><button class="holding-nav-button" on-tap="{{next}}"><span class="hide-nav">Next</span>&#62;&#62;</button></div>
                            <div><button class="holding-nav-button" on-tap="{{last}}">Last</button></div>
                        </core-selector>
                        <div class="size-menu-wrapper">
                            <span class="size-label">Size</span>
                            <paper-dropdown-menu label="50">
                                <paper-dropdown class="dropdown">
                                    <core-selector class="menu" valueattr="val" selected="50">
                                        <paper-item val="50" class="current">50</paper-item>
                                        <paper-item val="100">100</paper-item>
                                        <paper-item val="200">200</paper-item>
                                    </core-selector>
                                </paper-dropdown>
                            </paper-dropdown-menu>
                        </div>
                    </div>
                </template>
                <div class="table-wrapper">
                    <div class="portfolio-table">
                        <div class="table-header-list">
                            <core-selector id="tableHeader" selected="name" valueattr="orderval">
                                <div class="col-padding table-header col-5" on-tap="{{order}}" orderval="name">
                                    Name
                                    <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                                </div>
                                <div class="col-padding table-header col-4" on-tap="{{order}}" orderval="nominal">
                                    Nominal
                                    <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                                </div>
                                <div class="col-padding table-header col-4" on-tap="{{order}}" orderval="costPrice">
                                    Cost Price
                                    <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                                </div>
                                <div class="col-padding table-header col-5" on-tap="{{order}}" orderval="bookValue">
                                    Book value (R)
                                    <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                                </div>
                                <div class="col-padding table-header col-5" on-tap="{{order}}" orderval="marketPrice">
                                    Market Price
                                    <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                                </div>
                                <div class="col-padding table-header col-5" on-tap="{{order}}" orderval="marketValue">
                                    Market Value
                                    <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                                </div>
                                <div class="col-padding table-header col-3" on-tap="{{order}}" orderval="MV">
                                    %MV
                                    <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                                </div>
                                <div class="col-padding table-header col-6" on-tap="{{order}}" orderval="exposureValue">
                                    Exposure Value (R)
                                    <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                                </div>
                            </core-selector>
                        </div>
                        <template repeat="{{val in portfolioHoldings}}">
                            <div class="table-body" hidden?="{{showAll}}">
                                <ul class="portfolio-link collapse-category" on-tap="{{toggle}}" toggleId="{{val.id}}" hidden?="{{hideCollapse}}">
                                    <li class="col-padding table-item col-13">
                                        <core-icon id="icon{{val.id}}" icon="arrow-drop-down"></core-icon>
                                        {{val.category}}
                                    </li>
                                    <li class="col-padding table-item col-5">{{val.averageBookVal}}</li>
                                    <li class="col-padding table-item col-5">{{val.averageMarcPrice}}</li>
                                    <li class="col-padding table-item col-5">{{val.averageMacVal}}</li>
                                    <li class="col-padding table-item col-3">{{val.averageMV}}</li>
                                    <li class="col-padding table-item col-6">{{val.averageExpVal}}</li>
                                </ul>
                                <core-collapse id="collapse{{val.id}}" class="collapse" opened>
                                    <template repeat="{{item in val.categoryItems | orderBy(oderVal)}}">
                                        <ul class="col-content portfolio-link">
                                            <li class="col-padding table-item col-5">{{item.name}}</li>
                                            <li class="col-padding table-item col-4">{{item.nominal}}</li>
                                            <li class="col-padding table-item col-4">{{item.costPrice}}</li>
                                            <li class="col-padding table-item col-5">{{item.bookValue}}</li>
                                            <li class="col-padding table-item col-5">{{item.marketPrice}}</li>
                                            <li class="col-padding table-item col-5">{{item.marketValue}}</li>
                                            <li class="col-padding table-item col-3">{{item.MV}}</li>
                                            <li class="col-padding table-item col-6">{{item.exposureValue}}</li>
                                        </ul>
                                    </template>
                                </core-collapse>
                            </div>
                        </template>
                        <div class="table-body" hidden?="{{!showAll}}">
                            <template repeat="{{item in allItems | orderBy(oderVal)}}">
                                <ul class="col-content portfolio-link">
                                    <li class="col-padding table-item col-5">{{item.name}}</li>
                                    <li class="col-padding table-item col-4">{{item.nominal}}</li>
                                    <li class="col-padding table-item col-4">{{item.costPrice}}</li>
                                    <li class="col-padding table-item col-5">{{item.bookValue}}</li>
                                    <li class="col-padding table-item col-5">{{item.marketPrice}}</li>
                                    <li class="col-padding table-item col-5">{{item.marketValue}}</li>
                                    <li class="col-padding table-item col-3">{{item.MV}}</li>
                                    <li class="col-padding table-item col-6">{{item.exposureValue}}</li>
                                </ul>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </side-menu>
        <app-globals id="globals"></app-globals>
        <core-ajax auto
                   id="portfolioItem"
                   on-core-response="{{contentResponse}}"></core-ajax>
    </template>
    <script>
        Polymer('portfolio-item',{
            ready: function(){
                this.$.portfolioItem.url = this.$.globals.url+'resources/json/portfolio-item.json';
                this.updateDateFormat();
            },
            contentResponse: function(e, data){
                var me = this;
                if(data.response.success){
                    me.portfolioItemContent = data.response.item;
                    me.portfolioCharts =  data.response.item.charts;
                    me.page.title = "Portfolio > "+ me.portfolioItemContent.title;
                    me.portfolioHoldings = data.response.item.holdings;
                    for (var i=0; i < me.portfolioHoldings.length; i++) {
                        var counter = i++;
                        me.allItems = me.portfolioHoldings[i].categoryItems.concat(me.portfolioHoldings[counter].categoryItems);
                    }
                }
            },
            page: {
                class: 'portfolio-item',
                url: 'portfolio/item/1',
                title: 'Portfolio > ...',
                tabs: true,
                panel: true
            },
            tabs: [{name: 'dashboard', label: 'Dashboard'}, {name:'holdings', label: 'Holdings'}],
            allItems:[],

            //Open/close calendar
            openCalendar: function(e) {
                this.calendarStatus = true;
            },
            closeCalendarDialog: function(e) {
                this.calendarStatus = false;
            },
            saveCalendarStatus: function(e) {
                this.calendarStatus = false;
                this.updateDateFormat();
            },

            //Update date format
            updateDateFormat: function (e){
                var monthNames = ["Jan", "Feb", "Mar",
                                  "Apr", "May", "Jun",
                                  "Jul", "Aug", "Sep",
                                  "Oct", "Nov", "Dec"];
                var date = this.selectedDate;
                var day = date.getDate();
                var monthIndex = date.getMonth();
                var year = date.getFullYear();

                this.curDate = day+' '+monthNames[monthIndex]+' '+year;
            },

            //Toggle page dropdown menu on fab tap
            menuPosition: 'top',
            openMenu: function(e){
                var me = this;
                var phoneScreen = '640';
                var width = window.innerWidth;
                if (width <= phoneScreen) {
                    me.menuPosition = 'bottom';
                }
                me.menuStatus = true;
            },

            //Toggle collapses in the table
            showAll:false,
            toggle: function(e) {
                var me = this;
                var id = e.currentTarget.attributes.toggleId.value;
                var collapse = me.$.holdings.querySelectorAll('#collapse'+id)[0];
                var icon = me.$.holdings.querySelectorAll('#icon'+id)[0];
                var action = 'rotate';
                collapse.toggle();
                me.rotate(icon, action);
            },

            //Rotate collapse icon function
            rotate: function (icon, actionClass){
                if (icon.classList.contains(actionClass)){
                    icon.classList.remove(actionClass);
                }
                else icon.classList.add(actionClass);
            },

            toggleStat: function (){
                var me = this;
                var category = me.$.holdings.querySelectorAll('.collapse');
                var tableHeader = this.$.holdings.querySelectorAll('#tableHeader')[0];
                for (var i=0; i < category.length; i++) {
                    if (category[i].classList.contains('core-collapse-closed')) {
                        category[i].toggle();
                    }
                }
                me.showAll = true;
                me.oderVal = 'name';
                tableHeader.selected='name';
            },

            toggleIcb: function (){
                this.showAll = false;
                var tableHeader = this.$.holdings.querySelectorAll('#tableHeader')[0];
                tableHeader.selected='name';
            },

            //Table page selection
            prev: function () {
                var pages = this.$.holdings.querySelectorAll('#pages')[0];
                pages.selectPrevious();
            },
            next: function () {
                var pages = this.$.holdings.querySelectorAll('#pages')[0];
                pages.selectNext();
            },
            first: function(){
                var pages = this.$.holdings.querySelectorAll('#pages')[0];
                pages.selected = 1;
            },
            last: function(){
                var pages = this.$.holdings.querySelectorAll('#pages')[0];
                pages.selected = 4;
            },

            //Order by action
            order: function (e){
                var criteria = e.currentTarget.attributes.orderval.value;
                this.oderVal = criteria;
            },
            oderVal:'name'
        })
    </script>
</polymer-element>