<link rel="import" href="date-selector.html">
<link rel="import" href="table-filter.html">
<link rel="import" href="page-selector.html">
<link rel="import" href="holdings-table.html">
<link rel="import" href="../dashboard/dashboard-charts.html">
<polymer-element name="portfolio-item" attributes="itemId">
    <template>
        <link rel="stylesheet" href="../../../css/portfolio-item.css">
        <!-- Main content -->
        <div layout vertical fit>
            <!-- Tabs toolbar -->
            <paper-shadow z="1">
                <core-toolbar>
                    <div class="bottom fit indent" horizontal layout>
                        <paper-tabs flex valueattr="name" selected="{{selectedTab}}">
                            <paper-tab name="dashboard">Dashboard</paper-tab>
                            <paper-tab name="holdings">Holdings</paper-tab>
                        </paper-tabs>
                    </div>
                </core-toolbar>
            </paper-shadow>
            <!--Subheader-->
            <paper-shadow z="1" class="subheader-shadow">
                <core-toolbar id="subheader" class="subheader" layout horizontal relative center>
                    <!--Calendar-->
                    <date-selector curDate="{{date}}"></date-selector>
                    <!--Holdings subheader-->
                    <template if="{{selectedTab == 'holdings'}}">
                        <!--Holdings table view dropdown menu-->
                        <div class="holding-view" layout horizontal center>
                            <core-icon icon="description" class="open-calendar-icon"></core-icon>
                            <paper-dropdown-menu>
                                <paper-dropdown class="dropdown">
                                    <core-selector class="menu" valueattr="view" selected="{{selectedView}}" id="views" on-core-select="{{changeView}}">
                                        <paper-item view="statutory" on-tap="{{toggleStat}}">Statutory</paper-item>
                                        <paper-item view="icb" on-tap="{{toggleIcb}}">ICB</paper-item>
                                    </core-selector>
                                </paper-dropdown>
                            </paper-dropdown-menu>
                        </div>
                        <!--"Filter by name" search-->
                        <table-filter flex showNoMatches="{{showNoMatches}}" allItems="{{allItems}}" portfolioItemsNoCategory="{{portfolioItemsNoCategory}}" showAll="{{selectedView}}"></table-filter>
                    </template>
                </core-toolbar>
            </paper-shadow>
            <core-pages valueattr="name" selected="{{selectedTab}}" flex>
                <section name="dashboard" class="content" fit>
                    <dashboard-charts class="content" fit dashboardContent="{{portfolioCharts}}" id="charts"></dashboard-charts>
                </section>
                <section name="holdings">
                    <div class="content" fit>
                        <page-selector pages="{{allPages}}" selectedPage="1" size="100" hidden?="{{selectedView == 'icb'}}"></page-selector>
                        <holdings-table portfolioHoldings="{{portfolioHoldings}}" allItems="{{allItems}}" selectedView="{{selectedView}}" showNoMatches="{{showNoMatches}}"></holdings-table>
                    </div>
                </section>
            </core-pages>
        </div>
        <app-globals id="globals"></app-globals>
        <core-ajax auto
                   id="portfolioItem"
                   on-core-response="{{contentResponse}}"></core-ajax>
    </template>
    <script>
        Polymer('portfolio-item',{
            ready: function(){
                this.$.portfolioItem.url = this.$.globals.url+'resources/json/portfolio-item'+this.itemId+'.json';
                //this.$.portfolioItem.url = this.$.globals.url+'resources/json/portfolio-item1.json';
                localStorage.setItem('selectedView','statutory');
                document.body.classList.remove('unresolved');
            },
            contentResponse: function(e, data){
                var me = this;
                if(data.response.success){
                    me.portfolioItemContent = data.response.item;
                    me.portfolioCharts =  data.response.item.charts;
                    me.portfolioHoldings = data.response.item.holdings;
                    //Content without categories generation
                    for (var i=0; i < me.portfolioHoldings.length; i++) {
                        var counter = i++;
                        me.allItems = me.portfolioHoldings[i].categoryItems.concat(me.portfolioHoldings[counter].categoryItems);
                    }
                    //Copy content to "filter by name" function
                    me.portfolioItemsNoCategory = me.allItems;
                    me.$.charts.updateDragAndDropsArray();
                }
            },
            build: false,
            allPages:[1,2,3,4],
            selectedTab: 'dashboard',
            selectedView: 'statutory',
            portfolioItemsNoCategory:[],

            //Toggle holdings table view
            toggleStat: function (){
                localStorage.setItem('selectedView','statutory');
                //var tableHeader = this.$.holdingPage.querySelector('#holdingsTable');
                //console.log(tableHeader);
                //tableHeader.selected='name';
            },
            toggleIcb: function (){
                localStorage.setItem('selectedView','icb');
                /*var me = this;
                var category = me.$.statutoryTable.querySelectorAll('.collapse');
                var tableHeader = this.$.statutoryTable.querySelector('#tableHeader');
                for (var i=0; i < category.length; i++) {
                    if (category[i].classList.contains('core-collapse-closed')) {
                        category[i].toggle();
                    }
                }
                me.oderVal = 'name';
                tableHeader.selected = 'name';*/
            }
        })
    </script>
</polymer-element>