<link rel="import" href="../dashboard/chart-board.html">
<polymer-element name="portfolio-item">
    <template>
        <link rel="stylesheet" href="../../../css/portfolio-item.css">
        <link rel="stylesheet" href="../../../css/calendar-dialog.css">
        <side-menu id="side" class="{{page.class}}" pageUrl="{{page.url}}" pageTitle="{{page.title}}" pageTabs="{{page.tabs}}" tabsArray="{{tabs}}" pagePanel="{{page.panel}}" tabHoldings="{{page.tabHoldingsStatus}}">
            <!--Subheader-->
            <div subheader class="indent subheader" layout horizontal flex id="subheader" relative>
                <!--Calendar-->
                <div class="calendar-block" layout horizontal center flex two>
                    <paper-button class="calendar-button" on-tap="{{openCalendar}}" relative layout horizontal>
                        <core-icon icon="event" class="open-calendar-icon"></core-icon>
                        <span class="selected-date">{{curDate}}</span>
                        <core-icon icon="arrow-drop-down" class="open-calendar-icon"></core-icon>
                    </paper-button>
                    <paper-dropdown opened="{{calendarStatus}}" id="calendarDialogWrapper">
                        <d-calendar class="portfolio-item-calendar" selectedDate="{{selectedDate}}" on-d-calendar-date-selected="{{dateSelected}}"></d-calendar>
                        <div class="actions">
                            <paper-button role="button" class="closeCalendar" on-tap="{{closeCalendarDialog}}">Cancel</paper-button>
                            <paper-button role="button" class="setDate" on-tap="{{saveCalendarStatus}}">OK</paper-button>
                        </div>
                    </paper-dropdown>
                </div>
                <!--Holdings subheader-->
                <template if="{{page.tabHoldingsStatus}}">
                    <!--Holdings table view dropdown menu-->
                    <div class="holding-view" layout horizontal center flex two>
                        <core-icon icon="description" class="open-calendar-icon"></core-icon>
                        <paper-dropdown-menu>
                            <paper-dropdown class="dropdown">
                                <core-selector class="menu" valueattr="view" selected="{{selectedView}}">
                                    <paper-item view="1" on-tap="{{toggleStat}}">Statutory</paper-item>
                                    <paper-item view="2" on-tap="{{toggleIcb}}">ICB</paper-item>
                                </core-selector>
                            </paper-dropdown>
                        </paper-dropdown-menu>
                    </div>
                    <!--"Filter by name" search-->
                    <div layout horizontal center flex six hidden?="{{phoneScreen}}" id="searchInput">
                        <template if="{{showAll}}">
                            <core-media-query query="max-width: 768px"
                                              queryMatches="{{phoneScreen}}"></core-media-query>
                            <core-field class="search-field" >
                                <input id="searchField" is="core-input" name="input" placeholder="Filter by name" flex on-keyup="{{filterByName}}">
                                <core-icon icon="search"></core-icon>
                            </core-field>
                        </template>
                    </div>
                    <div hidden?="{{!phoneScreen}}" layout horizontal center-center flex>
                        <core-icon-button icon="filter-list" on-tap="{{openFilter}}"></core-icon-button>
                        <paper-dropdown halign="right" opened="{{filtersStatus}}" class="mobile-filters">
                            <div class="menu filters-menu">
                                <template if="{{showAll}}">
                                    <core-field class="search-field">
                                        <input id="searchFieldMobile" is="core-input" name="input" placeholder="Filter by name" flex on-keyup="{{filterByName}}">
                                        <core-icon icon="search"></core-icon>
                                    </core-field>
                                </template>
                                <paper-item class="item" on-tap="{{order}}" orderval="name">
                                    <div class="label">Order by name</div>
                                    <paper-ripple fit></paper-ripple>
                                </paper-item>
                                <paper-item class="item" on-tap="{{order}}" orderval="nominal">
                                    <div class="label">Order by nominal</div>
                                    <paper-ripple fit></paper-ripple>
                                </paper-item>
                                <paper-item class="item" on-tap="{{order}}" orderval="costPrice">
                                    <div class="label">Order by cost price</div>
                                    <paper-ripple fit></paper-ripple>
                                </paper-item>
                                <paper-item class="item" on-tap="{{order}}" orderval="bookValue">
                                    <div class="label">Order by book value</div>
                                    <paper-ripple fit></paper-ripple>
                                </paper-item>
                                <paper-item class="item" on-tap="{{order}}" orderval="marketPrice">
                                    <div class="label">Order by market price</div>
                                    <paper-ripple fit></paper-ripple>
                                </paper-item>
                                <paper-item class="item" on-tap="{{order}}" orderval="marketValue">
                                    <div class="label">Order by market value</div>
                                    <paper-ripple fit></paper-ripple>
                                </paper-item>
                                <paper-item class="item" on-tap="{{order}}" orderval="MV">
                                    <div class="label">Order by %MV</div>
                                    <paper-ripple fit></paper-ripple>
                                </paper-item>
                                <paper-item class="item" on-tap="{{order}}" orderval="exposureValue">
                                    <div class="label">Order by exposure value</div>
                                    <paper-ripple fit></paper-ripple>
                                </paper-item>
                            </div>
                        </paper-dropdown>
                    </div>
                </template>
            </div>
            <!--Dashboard tab content-->
            <div tab0 class="dashboard-view tab-page-content" fit>
                <div class="dashboard-dropdown">
                    <paper-fab class="open" icon="add" on-tap="{{openMenu}}" relative></paper-fab>
                    <paper-dropdown opened="{{menuStatus}}" class="dashboard-menu-dropdown" halign="right" valign="{{menuPosition}}">
                        <div class="menu-list menu">
                            <paper-item class="item">
                                <div class="label">Holding Charts</div>
                                <paper-ripple fit></paper-ripple>
                            </paper-item>
                            <paper-item class="item">
                                <div class="label" >Corporate Events</div>
                                <paper-ripple fit></paper-ripple>
                            </paper-item>
                            <paper-item class="item">
                                <div class="label">Calendar Events</div>
                                <paper-ripple fit></paper-ripple>
                            </paper-item>
                        </div>
                    </paper-dropdown>
                </div>
                <template repeat="{{val, i in portfolioCharts}}">
                    <chart-board name="{{val.name}}" type="{{val.type}}" values="{{val.data}}" dashboardContent="{{portfolioCharts}}" id="{{i}}"></chart-board>
                </template>
            </div>
            <!--Holdings tab content-->
            <div tab1 class="holdings-view tab-page-content" fit id="holdings">
                <!--Pagination of holdings table-->
                <div class="holding-table-navigation-wrapper" hidden?="{{showAll}}">
                    <template is="auto-binding">
                        <core-media-query query="max-width: 768px"
                                          queryMatches="{{phoneScreen}}"></core-media-query>
                        <div layout vertical?="{{phoneScreen}}"
                             horizontal?="{{!phoneScreen}}" start?="{{!phoneScreen}}" class="holding-table-navigation">
                            <core-selector layout horizontal start>
                                <div><button class="holding-nav-button" on-tap="{{first}}">First</button></div>
                                <div><button class="holding-nav-button" on-tap="{{prev}}">&#60;&#60;<span class="hide-nav">Prev</span></button></div>
                                <core-selector id="pages" valueattr="name" selected="1" layout horizontal start>
                                    <div name="1" class="table-page-item">1</div>
                                    <div name="2" class="table-page-item">2</div>
                                    <div name="3" class="table-page-item">3</div>
                                    <div name="4" class="table-page-item">4</div>
                                </core-selector>
                                <div><button class="holding-nav-button" on-tap="{{next}}"><span class="hide-nav">Next</span>&#62;&#62;</button></div>
                                <div><button class="holding-nav-button" on-tap="{{last}}">Last</button></div>
                            </core-selector>
                            <div class="size-menu-wrapper">
                                <span class="size-label">Size</span>
                                <paper-dropdown-menu label="50">
                                    <paper-dropdown class="dropdown">
                                        <core-selector class="menu" valueattr="val" selected="50">
                                            <paper-item val="50" class="current">50</paper-item>
                                            <paper-item val="100">100</paper-item>
                                            <paper-item val="200">200</paper-item>
                                        </core-selector>
                                    </paper-dropdown>
                                </paper-dropdown-menu>
                            </div>
                        </div>
                    </template>
                </div>
                <!--Holdings table-->
                <div class="table-wrapper">
                    <core-media-query query="max-width: 768px"
                                      queryMatches="{{phoneScreen}}"></core-media-query>
                    <div class="table-header-list" hidden?="{{phoneScreen}}">
                        <core-selector id="tableHeader" selected="name" valueattr="orderval" layout horizontal?="{{!phoneScreen}}">
                            <div class="col-padding table-header link" flex four on-tap="{{order}}" orderval="name">
                                Name
                                <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                            </div>
                            <div class="col-padding table-header link" flex three on-tap="{{order}}" orderval="nominal">
                                Nominal
                                <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                            </div>
                            <div class="col-padding table-header link" flex three on-tap="{{order}}" orderval="costPrice">
                                Cost Price
                                <core-icon icon="arrow-drop-down" class="filter-icon cost-price-icon"></core-icon>
                            </div>
                            <div class="col-padding table-header link" flex four on-tap="{{order}}" orderval="bookValue">
                                Book value (R)
                                <core-icon icon="arrow-drop-down" class="filter-icon book-value-icon"></core-icon>
                            </div>
                            <div class="col-padding table-header link" flex four on-tap="{{order}}" orderval="marketPrice">
                                Market Price
                                <core-icon icon="arrow-drop-down" class="filter-icon market-price-icon"></core-icon>
                            </div>
                            <div class="col-padding table-header link" flex four on-tap="{{order}}" orderval="marketValue">
                                Market Value
                                <core-icon icon="arrow-drop-down" class="filter-icon market-value-icon"></core-icon>
                            </div>
                            <div class="col-padding table-header link" flex two on-tap="{{order}}" orderval="MV">
                                %MV
                                <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                            </div>
                            <div class="col-padding table-header link" flex five on-tap="{{order}}" orderval="exposureValue">
                                Exposure Value (R)
                                <core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>
                            </div>
                        </core-selector>
                    </div>
                    <!--Holdings table statutory view-->
                    <div class="table-body no-padding-bottom" hidden?="{{showAll}}">
                        <template repeat="{{val in portfolioHoldings}}">
                            <div layout horizontal class="collapse-category" on-tap="{{toggle}}" toggleId="{{val.id}}" hidden?="{{hideCollapse}}">
                                <div class="col-padding table-item category-title" flex eleven>
                                    <core-icon id="icon{{val.id}}" class="category-icon" icon="arrow-drop-down"></core-icon>
                                    {{val.category}}
                                </div>
                                <div class="col-padding table-item" flex four hidden?="{{phoneScreen}}">{{val.averageBookVal}}</div>
                                <div class="col-padding table-item" flex four hidden?="{{phoneScreen}}">{{val.averageMarcPrice}}</div>
                                <div class="col-padding table-item" flex four hidden?="{{phoneScreen}}">{{val.averageMacVal}}</div>
                                <div class="col-padding table-item" flex two hidden?="{{phoneScreen}}">{{val.averageMV}}</div>
                                <div class="col-padding table-item" flex five hidden?="{{phoneScreen}}">{{val.averageExpVal}}</div>
                            </div>
                            <core-collapse id="collapse{{val.id}}" class="collapse" opened>
                                <core-selector selected="0" valueattr="number">
                                    <template repeat="{{item, i in val.categoryItems | orderBy(oderVal)}}">
                                        <div layout vertical?="{{phoneScreen}}" number="{{i}}">
                                            <h1 hidden?="{{!phoneScreen}}" class="table-header-in-collapse">{{item.name}}</h1>
                                            <div layout horizontal?="{{phoneScreen}}" class="mobile-col-content">
                                                <!--Holdings table-headers for mobile view-->
                                                <div class="col-content labels" hidden?="{{!phoneScreen}}">
                                                    <div class="col-padding table-item table-label">Nominal</div>
                                                    <div class="col-padding table-item table-label">Cost Price</div>
                                                    <div class="col-padding table-item table-label">Book Value (R)</div>
                                                    <div class="col-padding table-item table-label">Market Price</div>
                                                    <div class="col-padding table-item table-label">Market Value</div>
                                                    <div class="col-padding table-item table-label">%MV</div>
                                                    <div class="col-padding table-item table-label">Exposure Value (R)</div>
                                                </div>
                                                <div class="col-content values" layout?="{{!phoneScreen}}" horizontal?="{{!phoneScreen}}">
                                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}" hidden?="{{phoneScreen}}">{{item.name}}</div>
                                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" three?="{{!phoneScreen}}">{{item.nominal}}</div>
                                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" three?="{{!phoneScreen}}">{{item.costPrice}}</div>
                                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.bookValue}}</div>
                                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.marketPrice}}</div>
                                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.marketValue}}</div>
                                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" two?="{{!phoneScreen}}">{{item.MV}}</div>
                                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" five?="{{!phoneScreen}}">{{item.exposureValue}}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </core-selector>
                            </core-collapse>
                        </template>
                    </div>
                    <!--Holdings table ICB view-->
                    <div class="table-body" hidden?="{{!showAll}}">
                        <core-selector selected="0" valueattr="number">
                            <template repeat="{{item, i in allItems | orderBy(oderVal)}}">
                                <div layout vertical?="{{phoneScreen}}" number="{{i}}">
                                    <h1 hidden?="{{!phoneScreen}}" class="table-header table-header-list">{{item.name}}</h1>
                                    <div layout horizontal?="{{phoneScreen}}" class="mobile-col-content">
                                        <!--Holdings table-headers for mobile view-->
                                        <div class="col-content labels" hidden?="{{!phoneScreen}}">
                                            <div class="col-padding table-item table-label">Nominal</div>
                                            <div class="col-padding table-item table-label">Cost Price</div>
                                            <div class="col-padding table-item table-label">Book Value (R)</div>
                                            <div class="col-padding table-item table-label">Market Price</div>
                                            <div class="col-padding table-item table-label">Market Value</div>
                                            <div class="col-padding table-item table-label">%MV</div>
                                            <div class="col-padding table-item table-label">Exposure Value (R)</div>
                                        </div>
                                        <div class="col-content values" layout?="{{!phoneScreen}}" horizontal?="{{!phoneScreen}}">
                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}" hidden?="{{phoneScreen}}">{{item.name}}</div>
                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" three?="{{!phoneScreen}}">{{item.nominal}}</div>
                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" three?="{{!phoneScreen}}">{{item.costPrice}}</div>
                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.bookValue}}</div>
                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.marketPrice}}</div>
                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.marketValue}}</div>
                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" two?="{{!phoneScreen}}">{{item.MV}}</div>
                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" five?="{{!phoneScreen}}">{{item.exposureValue}}</div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                            <!--No matches message-->
                            <div layout vertical?="{{phoneScreen}}">
                                <template if="{{showNoMatches}}">
                                    <span class="no-matches">No matches for your request. Try again!</span>
                                </template>
                            </div>
                        </core-selector>
                    </div>
                </div>
            </div>
        </side-menu>
        <app-globals id="globals"></app-globals>
        <core-ajax auto
                   id="portfolioItem"
                   on-core-response="{{contentResponse}}"></core-ajax>
    </template>
    <script>
        Polymer('portfolio-item',{
            ready: function(){
                this.$.portfolioItem.url = this.$.globals.url+'resources/json/portfolio-item.json';
                this.updateDateFormat();
            },
            contentResponse: function(e, data){
                var me = this;
                if(data.response.success){
                    me.portfolioItemContent = data.response.item;
                    me.portfolioCharts =  data.response.item.charts;
                    me.page.title = "Portfolio > "+ me.portfolioItemContent.title;
                    me.portfolioHoldings = data.response.item.holdings;
                    //Content without categories generation
                    for (var i=0; i < me.portfolioHoldings.length; i++) {
                        var counter = i++;
                        me.allItems = me.portfolioHoldings[i].categoryItems.concat(me.portfolioHoldings[counter].categoryItems);
                    }
                    //Copy content to "filter by name" function
                    me.portfolioItemsNoCategory =  me.allItems;
                }
            },
            page: {
                class: 'portfolio-item',
                url: 'portfolio/item/',
                title: 'Portfolio > ...',
                tabs: true,
                panel: true,
                tabHoldingsStatus:false
            },
            tabs: [{name: 'dashboard', label: 'Dashboard'}, {name:'holdings', label: 'Holdings'}],
            selectedView: 1,
            portfolioItemsNoCategory:[],

            getId: function(){
                return this.id;
            },

            //Search "Filter by name" function
            filterByName: function (e) {
                var me = this;
                var filtered = [];
                var id = e.currentTarget.id;
                var searchField = me.$.subheader.querySelector('#'+id);
                var searchValue = searchField.value;
                var items =  me.portfolioItemsNoCategory;
                var letterMatch = new RegExp(searchValue, 'i');

                me.showNoMatches = false;
                for (var i = 0; i < items.length; i++) {
                    var item = items[i];
                    if (letterMatch.test(item.name)) {
                        filtered.push(item);
                    }
                }
                if (filtered.length <=0) {
                    me.showNoMatches=true;
                }
                return me.allItems = filtered;
            },

            //Open/close calendar
            openCalendar: function(e) {
                this.calendarStatus = true;
            },
            closeCalendarDialog: function(e) {
                this.calendarStatus = false;
            },
            saveCalendarStatus: function(e) {
                this.calendarStatus = false;
                this.updateDateFormat();
            },

            //Update date format
            updateDateFormat: function (e){
                var monthNames = ["Jan", "Feb", "Mar",
                                  "Apr", "May", "Jun",
                                  "Jul", "Aug", "Sep",
                                  "Oct", "Nov", "Dec"];
                var date = this.selectedDate;
                var day = date.getDate();
                var monthIndex = date.getMonth();
                var year = date.getFullYear();

                this.curDate = day+' '+monthNames[monthIndex]+' '+year;
            },

            //Toggle position of dashboard dropdown menu
            menuPosition: 'top',
            openMenu: function(e){
                var me = this;
                var phoneScreen = '640';
                var width = window.innerWidth;
                if (width <= phoneScreen) {
                    me.menuPosition = 'bottom';
                }
                me.menuStatus = true;
            },

            //Toggle collapses(categories) in the table
            showAll:false,
            toggle: function(e) {
                var me = this;
                var id = e.currentTarget.attributes.toggleId.value;
                var collapse = me.$.holdings.querySelector('#collapse'+id);
                var icon = me.$.holdings.querySelector('#icon'+id);
                var action = 'rotate';
                collapse.toggle();
                me.rotate(icon, action);
            },

            //Rotate collapse icon function
            rotate: function (icon, actionClass){
                if (icon.classList.contains(actionClass)){
                    icon.classList.remove(actionClass);
                }
                else icon.classList.add(actionClass);
            },

            //Toggle holdings table view
            toggleStat: function (){
                var tableHeader = this.$.holdings.querySelector('#tableHeader');
                tableHeader.selected='name';
                this.showAll = false;
            },
            toggleIcb: function (){
                var me = this;
                var category = me.$.holdings.querySelectorAll('.collapse');
                var tableHeader = this.$.holdings.querySelector('#tableHeader');
                for (var i=0; i < category.length; i++) {
                    if (category[i].classList.contains('core-collapse-closed')) {
                        category[i].toggle();
                    }
                }
                me.showAll = true;
                me.oderVal = 'name';
                tableHeader.selected = 'name';
            },

            //Table page selection
            prev: function () {
                var pages = this.$.holdings.querySelector('#pages');
                pages.selectPrevious();
            },
            next: function () {
                var pages = this.$.holdings.querySelector('#pages');
                pages.selectNext();
            },
            first: function(){
                var pages = this.$.holdings.querySelector('#pages');
                pages.selected = 1;
            },
            last: function(){
                var pages = this.$.holdings.querySelector('#pages');
                pages.selected = 4;
            },

            //"Order by" action
            oderVal:'name',
            order: function (e){
                var criteria = e.currentTarget.attributes.orderval.value;
                this.oderVal = criteria;
            },

            //Toggle filtering dropdown(mobile view)
            openFilter: function(){
                this.filtersStatus = true;
            }
        })
    </script>
</polymer-element>