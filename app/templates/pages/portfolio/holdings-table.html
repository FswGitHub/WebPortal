<link rel="import" href="page-selector.html">
<polymer-element name="holdings-table" attributes="showNoMatches allItems portfolioItemsNoCategory showAll request portfolio">
    <template>
        <link rel="stylesheet" href="../../../css/portfolio-page.css">
        <link rel="stylesheet" href="../../../css/portfolio-item.css">
        <page-selector pages="{{allPages}}" selectedPage="{{page}}" sizes="{{sizes}}" size="{{rowSize}}" oderVal="{{oderVal}}"></page-selector>
        <!--Holdings table-->
        <div class="table-wrapper">
            <core-media-query query="max-width: 768px"
                              queryMatches="{{phoneScreen}}"></core-media-query>
            <div class="table-header-list" hidden?="{{phoneScreen}}">
                <core-selector id="tableHeader" selected="name" valueattr="orderval" layout horizontal?="{{!phoneScreen}}">
                    <div class="col-padding table-header link" flex four on-tap="{{order}}" orderval="name">
                        <span>Name</span>
                        <!--<core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>-->
                    </div>
                    <div class="col-padding table-header link" flex three on-tap="{{order}}" orderval="nominal">
                        <span>Nominal</span>
                        <!--<core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>-->
                    </div>
                    <div class="col-padding table-header link" flex three on-tap="{{order}}" orderval="costPrice">
                        <!--<core-icon icon="arrow-drop-down" class="filter-icon cost-price-icon"></core-icon>-->
                        <span>Cost Price</span>
                    </div>
                    <div class="col-padding table-header link" flex four on-tap="{{order}}" orderval="bookValue">
                        <!--<core-icon icon="arrow-drop-down" class="filter-icon book-value-icon"></core-icon>-->
                        <span>Book value (R)</span>
                    </div>
                    <div class="col-padding table-header link" flex four on-tap="{{order}}" orderval="marketPrice">
                        <!--<core-icon icon="arrow-drop-down" class="filter-icon market-price-icon"></core-icon>-->
                        <span>Market Price</span>
                    </div>
                    <div class="col-padding table-header link" flex four on-tap="{{order}}" orderval="marketValue">
                        <!--<core-icon icon="arrow-drop-down" class="filter-icon market-value-icon"></core-icon>-->
                        <span>Market Value</span>
                    </div>
                    <div class="col-padding table-header link" flex two on-tap="{{order}}" orderval="MV">
                        <!--<core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>-->
                        <span>%MV</span>
                    </div>
                    <div class="col-padding table-header link" flex five on-tap="{{order}}" orderval="exposureValue">
                        <!--<core-icon icon="arrow-drop-down" class="filter-icon"></core-icon>-->
                        <span>Exposure Value (R)</span>
                    </div>
                </core-selector>
            </div>
            <!--Holdings table statutory view-->
            <div id="statutoryTable" hidden?="{{showAll}}">
                <core-pages valueattr="page" selected="{{page}}">
                    <template repeat="{{pageItem, i in allPages}}">
                        <section page="{{pageItem}}">
                            <div class="table-body no-padding-bottom">
                                <template repeat="{{val in portfolioHoldings}}">
                                    <div layout horizontal class="collapse-category" on-tap="{{toggle}}" toggleId="{{val.id+i}}" hidden?="{{val.categoryItems.length <= pageItem.from}}">
                                        <div class="col-padding table-item category-title" flex seven>
                                            <core-icon id="icon{{val.id+i}}" class="category-icon" icon="arrow-drop-down"></core-icon>
                                            {{val.category}}
                                        </div>
                                        <div class="col-padding table-item" flex three hidden?="{{phoneScreen}}">{{val.costPrice}}</div>
                                        <div class="col-padding table-item" flex four hidden?="{{phoneScreen}}">{{val.totalBookValue}}</div>
                                        <div class="col-padding table-item" flex four hidden?="{{phoneScreen}}">{{val.averageMarketPrice}}</div>
                                        <div class="col-padding table-item" flex four hidden?="{{phoneScreen}}">{{val.totalMarketValue}}</div>
                                        <div class="col-padding table-item" flex two hidden?="{{phoneScreen}}">{{val.totalPercentageMV}}</div>
                                        <div class="col-padding table-item" flex five hidden?="{{phoneScreen}}">{{val.totalExposureValue}}</div>
                                    </div>
                                    <core-collapse id="collapse{{val.id+i}}" class="collapse" opened>
                                        <core-selector selected="0" valueattr="number" class="collapse-content">
                                            <template repeat="{{item, i in val.categoryItems | orderBy(oderVal) | limitFrom(pageItem.from,pageItem.to)}}">
                                                <div layout vertical?="{{phoneScreen}}" number="{{i}}" >
                                                    <h1 hidden?="{{!phoneScreen}}" class="table-header-in-collapse">{{item.name}}</h1>
                                                    <div layout horizontal?="{{phoneScreen}}" class="mobile-col-content">
                                                        <!--Holdings table-headers for mobile view-->
                                                        <div class="col-content labels" hidden?="{{!phoneScreen}}">
                                                            <div class="col-padding table-item table-label">Nominal</div>
                                                            <div class="col-padding table-item table-label">Cost Price</div>
                                                            <div class="col-padding table-item table-label">Book Value (R)</div>
                                                            <div class="col-padding table-item table-label">Market Price</div>
                                                            <div class="col-padding table-item table-label">Market Value</div>
                                                            <div class="col-padding table-item table-label">%MV</div>
                                                            <div class="col-padding table-item table-label">Exposure Value (R)</div>
                                                        </div>
                                                        <div class="col-content values" layout?="{{!phoneScreen}}" horizontal?="{{!phoneScreen}}">
                                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}" hidden?="{{phoneScreen}}">{{item.name}}</div>
                                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" three?="{{!phoneScreen}}">{{item.nominal}}</div>
                                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" three?="{{!phoneScreen}}">{{item.costPrice}}</div>
                                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.bookValue}}</div>
                                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.marketPrice}}</div>
                                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.marketValue}}</div>
                                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" two?="{{!phoneScreen}}">{{item.MV}}</div>
                                                            <div class="col-padding table-item" flex?="{{!phoneScreen}}" five?="{{!phoneScreen}}">{{item.exposureValue}}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                        </core-selector>
                                    </core-collapse>
                                </template>
                            </div>
                            <template if="{{i == (allPages.length - 1)}}">
                                <div layout horizontal center-center class="category-totals" hidden?="{{phoneScreen}}">
                                    <div class="col-padding table-item portfolio-total-label" flex seven hidden?="{{phoneScreen}}">{{portfolio}} TOTAL</div>
                                    <div class="col-padding table-item" flex three>{{classificationContent.costPrice}}</div>
                                    <div class="col-padding table-item" flex four>{{classificationContent.totalBookValue}}</div>
                                    <div class="col-padding table-item" flex four>{{classificationContent.averageMarketPrice}}</div>
                                    <div class="col-padding table-item" flex four>{{classificationContent.totalMarketValue}}</div>
                                    <div class="col-padding table-item" flex two>{{classificationContent.totalPercentageMV}}</div>
                                    <div class="col-padding table-item" flex five>{{classificationContent.totalExposureValue}}</div>
                                </div>
                            </template>
                        </section>
                    </template>
                </core-pages>
            </div>
            <!--Holdings table ICB view-->
            <div class="table-body" hidden?="{{!showAll}}">
                <core-selector selected="0" valueattr="number">
                    <template repeat="{{item, i in allItems | orderBy(oderVal)}}">
                        <div layout vertical?="{{phoneScreen}}" number="{{i}}">
                            <h1 hidden?="{{!phoneScreen}}" class="table-header table-header-list">{{item.name}}</h1>
                            <div layout horizontal?="{{phoneScreen}}" class="mobile-col-content">
                                <!--Holdings table-headers for mobile view-->

                                <div class="col-content labels" hidden?="{{!phoneScreen}}">
                                    <div class="col-padding table-item table-label">Nominal</div>
                                    <div class="col-padding table-item table-label">Cost Price</div>
                                    <div class="col-padding table-item table-label">Book Value (R)</div>
                                    <div class="col-padding table-item table-label">Market Price</div>
                                    <div class="col-padding table-item table-label">Market Value</div>
                                    <div class="col-padding table-item table-label">%MV</div>
                                    <div class="col-padding table-item table-label">Exposure Value (R)</div>
                                </div>
                                <div class="col-content values" layout?="{{!phoneScreen}}" horizontal?="{{!phoneScreen}}">
                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}" hidden?="{{phoneScreen}}">{{item.name}}</div>
                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" three?="{{!phoneScreen}}">{{item.nominal}}</div>
                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" three?="{{!phoneScreen}}">{{item.costPrice}}</div>
                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.bookValue}}</div>
                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.marketPrice}}</div>
                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" four?="{{!phoneScreen}}">{{item.marketValue}}</div>
                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" two?="{{!phoneScreen}}">{{item.MV}}</div>
                                    <div class="col-padding table-item" flex?="{{!phoneScreen}}" five?="{{!phoneScreen}}">{{item.exposureValue}}</div>
                                </div>
                            </div>
                        </div>
                    </template>
                    <!--No matches message-->
                    <div layout vertical?="{{phoneScreen}}">
                        <template if="{{showNoMatches}}">
                            <span class="no-matches">No matches for your request. Try again!</span>
                        </template>
                    </div>
                </core-selector>
            </div>
        </div>
        <core-ajax auto
                   id="classificationItems"
                   on-core-response="{{contentResponse}}" url="{{request}}"></core-ajax>
    </template>
    <script>
        Polymer('holdings-table',{
            ready: function(){
                //this.$.classificationItems.url = this.request;
                this.page = 0;
                this.portfolioItemsNoCategory = [];
            },
            contentResponse: function(e, data){
                var me = this;
                if(data.response.success) {
                    me.classificationContent = data.response.item;
                    me.holdings = data.response.item.holdings;
                    me.allItems = [];
                    me.portfolioHoldings = me.holdings;
                    me.sizes = this.getSizes(me.portfolioHoldings);
                    me.rowSize = me.sizes[1];
                    me.allPages = this.makePages(me.portfolioHoldings, me.rowSize);
                    //Content without categories generation
                    for (var i=0; i < me.portfolioHoldings.length; i++) {
                        me.allItems = me.allItems.concat(me.portfolioHoldings[i].categoryItems);
                    }

                    //Copy content to "filter by name" function
                    me.portfolioItemsNoCategory = me.allItems;
                }
                else {
                    me.allItems = new Array(10);
                    me.allPages = [{
                        cutCategory: 0,
                        lastCategory: 2
                    }];
                    me.portfolioHoldings = {
                        categoryItems:new Array(10)
                    };
                    me.sizes = [50,100,200];
                    me.rowSize = me.sizes[1];
                }
            },
            //Toggle collapses(categories) in the table
            toggle: function(e) {
                var me = this;
                var id = e.currentTarget.attributes.toggleId.value;
                var collapse = me.$.statutoryTable.querySelector('#collapse'+id);
                var icon = me.$.statutoryTable.querySelector('#icon'+id);
                var action = 'rotate';
                collapse.toggle();
                me.rotate(icon, action);
            },

            //Rotate collapse icon function
            rotate: function (icon, actionClass){
                if (icon.classList.contains(actionClass)){
                    icon.classList.remove(actionClass);
                }
                else icon.classList.add(actionClass);
            },

            //"Order by" action
            oderVal:'name',
            order: function (e){
                var criteria = e.currentTarget.attributes.orderval.value;
                this.oderVal = criteria;
            },

            //Sort rows to pages
            makePages: function(data, size){
                size = parseInt(size);
                var me  = this;
                var allPages = [];
                var maxCateroriesValues = this.getAllValues(data);
                var maxSize = this.getMaxValue(maxCateroriesValues);
                var pages = Math.ceil(maxSize/size);

                var f = 0;
                var n = size;

                for (var i=0; i< pages; i++) {
                    var page = {};
                    page.from = f;
                    page.to  = n;

                    allPages.push(page);
                    f = n;
                    n = n+size;
                }

                return allPages
            },

            getAllValues: function (array){
                var newMass = [];
                for (var i=0; i < array.length; i++) {
                    var category = array[i];
                    var fullSize = category.categoryItems.length;
                    newMass.push(fullSize);
                }
                return newMass;
            },

            getMaxValue: function (array){
                var max = array[0]; // берем первый элемент массива
                for (var i = 0; i < array.length; i++) { // переберем весь массив
                    // если элемент больше, чем в переменной, то присваиваем его значение переменной
                    if (max < array[i]) max = array[i];
                }
                // возвращаем максимальное значение
                return max;
            },

            getSizes: function(data){
                var sizesArray = [];
                var maxCateroriesValues = this.getAllValues(data);
                var maxSize = this.getMaxValue(maxCateroriesValues);
                var categories = maxCateroriesValues.length;
                var valuesSum = this.getSum(maxCateroriesValues);
                var average = Math.round(valuesSum/categories);
                var increment = this.setIncrement(average);

                if (increment == 5) {
                    sizesArray = [3, 5, 10];
                } else {
                    sizesArray = [increment/2, increment, increment*2];
                }
                return sizesArray;
            },

            getSum: function(array){
                var sum = 0;
                for(var i=0; i< array.length; i++){
                    sum = sum + array[i];
                }
                return sum;
            },

            setIncrement: function(average){
                var increment = 1;

                if (average <= 10){
                    if (average <= 5){increment = 5;}
                    else {increment = 10;}
                }
                else {
                    if (average <= 100){
                        if (average <= 50){increment = 50;}
                        else {increment = 100;}
                    }
                    else {increment = 100;}
                }

                return increment;
            },

            rowSizeChanged: function(){
                var me = this;
                me.allPages = this.makePages(me.portfolioHoldings, me.rowSize);
                me.page = 0;
            }
        });
    </script>
</polymer-element>